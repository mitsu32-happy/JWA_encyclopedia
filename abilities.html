<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アビリティ一覧 | JWA非公式Wiki</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/abilities.css" />
  <style>
    .filter-apply-btn{
      height:34px;
      padding:0 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.35);
      color: var(--color-text-muted);
      font-weight:700;
      cursor:pointer;
    }
    .filter-apply-btn:active{transform:translateY(1px)}
  
/* v2.2: 文字・リンクの見た目を他ページに寄せる */
a {
  color: inherit;
  text-decoration: none;
}
a:hover { text-decoration: underline; }
.card-title, .ability-name, .creature-name {
  letter-spacing: 0.2px;
}
.ability-name {
  font-weight: 800;
}
.meta-item {
  font-size: 12px;
  opacity: 0.9;
}



/* --- v2.2 UI unify: links & titles (match creatures list feel) --- */
.ability-card a, .ability-item a {
  color: inherit;
  text-decoration: none;
}
.ability-card a:hover, .ability-item a:hover {
  text-decoration: underline;
  text-underline-offset: 3px;
}
.ability-name {
  margin: 0;
  font-size: 16px;
  font-weight: 800;
  line-height: 1.2;
}
.ability-trigger {
  margin-top: 4px;
  font-size: 12px;
  opacity: 0.9;
}

</style>
</head>
<body>
  <div class="page page--inner">

    <!-- ▼ 共通ヘッダー -->
    <header class="site-header">
      <div class="logo-area">
        <img src="images/ui/logo_jwa_wiki.png" class="site-logo" alt="JWA非公式Wiki">
        <div>
          <div class="site-title-main">JWA非公式Wiki</div>
          <div class="site-title-sub">〜ジュラ会監修〜</div>
        </div>
      </div>
    </header>

    <!-- ▼ メイン -->
    <main class="page-main">
      <div class="page-inner">

        <!-- ==== ページヘッド ==== -->
        <section class="page-head">
          <div class="page-top-nav">
            <h1 class="page-title">アビリティ一覧</h1>
            <div style="display:flex; gap:6px;">
              <a href="creatures.html" class="btn btn--outline btn--sm">恐竜図鑑へ</a>
              <a href="index.html" class="btn btn--outline btn--sm">トップに戻る</a>
            </div>
          </div>

          <p class="page-subtitle">
            JWAに登場するアビリティを、タブと検索で絞り込んで閲覧できます。
          </p>

          <!-- タブ：トリガー種別による絞り込み -->
          <div class="meta-tabs" id="trigger-tabs">
            <button class="meta-tab meta-tab--active" data-trigger-filter="all">すべて</button>
            <button class="meta-tab" data-trigger-filter="Regular">通常攻撃</button>
            <button class="meta-tab" data-trigger-filter="Counter">カウンター</button>
            <button class="meta-tab" data-trigger-filter="On Escape">逃走関連</button>
          </div>
        </section>

        <!-- ==== フィルターUI ==== -->
        <section class="page-filters" style="margin-bottom: 10px;">

          <div style="display:flex; gap:6px; align-items:flex-end;">
            <div style="flex:1;">
              <input
                id="filter-name"
                type="search"
                placeholder="アビリティ名で検索（日本語・英語どちらも可）"
                style="
                  width: 100%;
                  padding: 8px 10px;
                  border-radius: 999px;
                  border: 1px solid rgba(255,255,255,0.25);
                  background: rgba(0,0,0,0.6);
                  color: #fff;
                  font-size: 0.8rem;
                  outline: none;
                "
              />
          <button id="filter-apply" class="filter-apply-btn" type="button">検索</button>
            </div>

            <button
              id="filter-reset"
              class="btn btn--outline btn--sm"
              type="button"
              style="margin-left:auto; margin-bottom:0;"
            >
              絞り込みをリセット
            </button>
          </div>
        </section>

        <!-- ==== 一覧本体 ==== -->
        <section class="page-content">
          <div class="grid grid--abilities" id="ability-grid">
            <!-- JSで abilities_master_ja.json から自動生成 -->
          </div>

          <div id="ability-empty-message" style="display:none; font-size:0.8rem; color:rgba(200,210,238,0.8); margin-top:8px;">
            条件に合致するアビリティが見つかりませんでした。
          </div>
        </section>

      </div>
    </main>

    <!-- ▼ 共通フッター -->
    <footer class="site-footer">
      非公式ファンサイトです。Jurassic World Alive の運営元とは関係ありません。
    </footer>
  </div>

  <!-- ==== abilities_master_ja.json 読み込み & フィルター ==== -->
  
<script>
(function(){
  const grid = document.getElementById("ability-grid");
  const emptyMsg = document.getElementById("ability-empty-message");

  const nameInput = document.getElementById("filter-name");
  const resetBtn  = document.getElementById("filter-reset");
  const applyBtn  = document.getElementById("filter-apply");

  const tabsWrap  = document.getElementById("trigger-tabs");
  const tabs      = tabsWrap ? Array.from(tabsWrap.querySelectorAll(".meta-tab")) : [];

  let allAbilities = [];
  let filteredAbilities = [];
  let activeTriggerFilter = "all";

  // 簡易バーチャルスクロール（遅延描画）
  const BATCH_SIZE = 80;
  let renderIndex = 0;
  let isLoadingMore = false;

  function safeText(v){ return (v ?? "").toString(); }

  function getAbilityName(ab){
    return safeText(ab.name_ja || ab.name || ab.id);
  }

  function getTrigger(ab){
    return safeText(ab.trigger || "");
  }

  function makeBackParam(){
    // 一覧状態をURLに保存しているので、それ自体を back として渡す
    return encodeURIComponent(location.pathname + location.search);
  }

  function renderAbilityCard(ab){
    const a = document.createElement("a");
    a.className = "card ability-card";
    a.href = `ability_detail.html?id=${encodeURIComponent(ab.id)}&back=${makeBackParam()}`;

    const icon = document.createElement("img");
    icon.className = "ability-icon";
    icon.alt = getAbilityName(ab);
    icon.src = ab.icon_file || "";
    a.appendChild(icon);

    const info = document.createElement("div");
    info.className = "ability-info";

    const name = document.createElement("div");
    name.className = "ability-name";
    name.textContent = getAbilityName(ab);

    const meta = document.createElement("div");
    meta.className = "ability-meta";
    const trig = getTrigger(ab);
    meta.textContent = trig ? `トリガー: ${trig}` : "";

    info.appendChild(name);
    info.appendChild(meta);
    a.appendChild(info);

    return a;
  }

  function clearGrid(){
    grid.innerHTML = "";
    renderIndex = 0;
  }

  function renderNextBatch(){
    if (isLoadingMore) return;
    isLoadingMore = true;

    const slice = filteredAbilities.slice(renderIndex, renderIndex + BATCH_SIZE);
    renderIndex += slice.length;

    const frag = document.createDocumentFragment();
    for (const ab of slice) frag.appendChild(renderAbilityCard(ab));
    grid.appendChild(frag);

    emptyMsg.style.display = filteredAbilities.length ? "none" : "block";
    isLoadingMore = false;
  }

  function updateQueryParams(){
    const params = new URLSearchParams();
    const q = (nameInput.value || "").trim();
    if (q) params.set("name", q);
    if (activeTriggerFilter !== "all") params.set("trigger", activeTriggerFilter);
    history.replaceState(null, "", `${location.pathname}?${params.toString()}`);
  }

  function loadQueryParamsIntoUI(){
    const params = new URLSearchParams(location.search);
    nameInput.value = params.get("name") || "";
    activeTriggerFilter = params.get("trigger") || "all";

    // タブの見た目を合わせる
    if (tabs.length){
      tabs.forEach(t => t.classList.toggle("meta-tab--active", (t.dataset.triggerFilter || "all") === activeTriggerFilter));
      // もし一致が無い場合は「すべて」をON
      if (!tabs.some(t => t.classList.contains("meta-tab--active"))) {
        tabs.forEach((t,i) => t.classList.toggle("meta-tab--active", i===0));
        activeTriggerFilter = "all";
      }
    }
  }

  function computeFilteredList(){
    const q = (nameInput.value || "").trim().toLowerCase();
    return allAbilities.filter(ab => {
      if (activeTriggerFilter !== "all" && safeText(ab.trigger) !== activeTriggerFilter) return false;
      if (q){
        const ja = safeText(ab.name_ja).toLowerCase();
        const en = safeText(ab.name).toLowerCase();
        const id = safeText(ab.id).toLowerCase();
        if (!ja.includes(q) && !en.includes(q) && !id.includes(q)) return false;
      }
      return true;
    });
  }

  function applyFilters(){
    filteredAbilities = computeFilteredList();
    clearGrid();
    updateQueryParams();
    renderNextBatch();
  }

  function onScrollLoadMore(){
    if (renderIndex >= filteredAbilities.length) return;
    const threshold = 700;
    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - threshold);
    if (nearBottom) renderNextBatch();
  }

  async function loadAbilities(){
    try{
      const res = await fetch("data/abilities_master_ja.json");
      if (!res.ok) throw new Error("HTTP status " + res.status);
      const json = await res.json();
      allAbilities = Object.values(json);

      allAbilities.sort((a,b)=>{
        const na = getAbilityName(a).toLowerCase();
        const nb = getAbilityName(b).toLowerCase();
        return na.localeCompare(nb);
      });

      loadQueryParamsIntoUI();
      applyFilters();
    }catch(e){
      console.error(e);
      grid.innerHTML = "<p>アビリティデータの読み込みに失敗しました。<br>data/abilities_master_ja.json のパスを確認してください。</p>";
    }
  }

  // イベント
  // v2.2: リアルタイム検索は重いので停止（検索ボタンで実行）
  // nameInput.addEventListener("input", applyFilters);

  applyBtn.addEventListener("click", applyFilters);
  nameInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter") applyFilters(); });

  resetBtn.addEventListener("click", ()=>{
    nameInput.value = "";
    activeTriggerFilter = "all";
    if (tabs.length){
      tabs.forEach((t,i)=>t.classList.toggle("meta-tab--active", i===0));
    }
    applyFilters();
  });

  tabs.forEach(tab=>{
    tab.addEventListener("click", ()=>{
      tabs.forEach(t => t.classList.remove("meta-tab--active"));
      tab.classList.add("meta-tab--active");
      activeTriggerFilter = tab.dataset.triggerFilter || "all";
      applyFilters();
    });
  });

  window.addEventListener("scroll", onScrollLoadMore, { passive:true });

  loadAbilities();
})();
</script>
</script>
</body>
</html>
